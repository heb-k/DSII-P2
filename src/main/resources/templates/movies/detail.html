<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${filme.title}">Detalhes</title>
    <link rel="stylesheet" th:href="@{/css/detail.css}">
</head>

<body>
<div class="page">

    <!-- CARD DO FILME -->
    <div class="movie-card">
        <div class="movie-poster">
            <img th:if="${filme.posterPath != null}"
                 th:src="'https://image.tmdb.org/t/p/w500' + ${filme.posterPath}">
            <img th:unless="${filme.posterPath != null}"
                 src="https://via.placeholder.com/500x750?text=Sem+Imagem">
        </div>

        <div class="movie-info">
            <h1 th:text="${filme.title}">T√≠tulo do Filme</h1>

            <div class="metadata">
                <span class="tag">üìÖ <span th:text="${filme.releaseDate}"></span></span>
                <!-- Map TMDB rating (0-100 or 0-10) to 0-5 stars and round to nearest 0.5 for consistent half-star display -->
                <span class="tag" th:with="avg=${filme.voteAverage}, stars=${avg > 10 ? (avg/20.0) : (avg/2.0)}, starsRounded=${T(java.lang.Math).round(stars*2)/2.0}">
                    <span th:each="i : ${#numbers.sequence(1,5)}"
                          th:classappend="${starsRounded >= i} ? 'star-filled' : (${starsRounded >= i - 0.5} ? 'star-half' : 'star-empty')"
                          class="review-star">‚òÖ</span>
                    <span class="rating-text" th:text="${avg > 10 ? '(' + avg + '/100)' : '(' + avg + '/10)'}"></span>
                </span>
            </div>

            <div class="overview-title">Sinopse</div>
            <p class="overview" th:text="${filme.overview}">Descri√ß√£o...</p>

            <a href="/movies" class="back-btn">‚¨Ö Voltar</a>
        </div>
    </div>


    <!-- FORM REVIEW -->
    <h2>Enviar Review</h2>

    <div th:if="${alreadyReviewed}">
        <p style="color:#ccc; background:#1a1a1a; padding:12px 16px; border-radius:10px; border-left:4px solid #ffcc00;">
            Voc√™ j√° enviou uma review para este filme.
        </p>
    </div>

    <form th:if="${!alreadyReviewed}" th:action="@{/reviews/create/{id}(id=${filme.id})}" method="post" id="reviewForm">
            <label>Avalia√ß√£o (Clique nas estrelas) <span style="color: #ff4444;">*</span></label>
        <div class="star-rating" id="starRating">
                <input type="hidden" name="rating" id="ratingInput" />
            <span class="star-clickable" data-value="1">‚òÖ</span>
            <span class="star-clickable" data-value="2">‚òÖ</span>
            <span class="star-clickable" data-value="3">‚òÖ</span>
            <span class="star-clickable" data-value="4">‚òÖ</span>
            <span class="star-clickable" data-value="5">‚òÖ</span>
        </div>
            <span id="ratingError" style="color: #ff4444; font-size: 0.9rem; display: none;">Por favor, selecione uma avalia√ß√£o</span>

        <label>Coment√°rio</label>
        <textarea name="comment" required></textarea>

        <button type="submit">Enviar Review</button>
    </form>


    <!-- LISTA DE REVIEWS -->
    <h2>Reviews</h2>

    <div th:if="${#lists.isEmpty(reviews)}">
        <p>N√£o h√° reviews para este filme.</p>
    </div>

    <div th:each="r : ${reviews}" class="review-card" th:attr="data-review-id=${r.id}">
        <div class="review-header">
            <div class="review-rating">
                <span th:with="stars=${r.rating}">
                    <span th:each="i : ${#numbers.sequence(1,5)}"
                          th:classappend="${stars >= i} ? 'star-filled' : (${stars >= i - 0.5} ? 'star-half' : 'star-empty')"
                          class="review-star">‚òÖ</span>
                </span>
                <span class="rating-text" th:text="'(' + ${r.rating} + '/5)'"></span>
            </div>
            <div class="review-actions" th:if="${currentUserId != null && r.user != null && currentUserId == r.user.id}">
                <button class="edit-btn" 
                        th:data-review-id="${r.id}"
                        th:data-comment="${r.comment}"
                        th:data-rating="${r.rating}"
                        th:onclick="'editReview(' + ${r.id} + ')'">‚úèÔ∏è Editar</button>
                <button class="delete-btn" th:onclick="'deleteReview(' + ${r.id} + ')'">üóëÔ∏è Excluir</button>
                <form th:id="'delete-form-' + ${r.id}" 
                      th:action="@{/reviews/delete/{id}(id=${r.id})}" 
                      method="post" 
                      style="display: none;">
                    <input type="hidden" name="movieId" th:value="${filme.id}">
                </form>
            </div>
        </div>
        <div class="review-author" th:if="${r.user != null}">
            Por: 
            <a th:if="${r.user.usernameField != null && !r.user.usernameField.isEmpty()}"
               th:href="@{/users/{username}(username=${r.user.usernameField})}"
               th:text="${r.user.usernameField}"
               style="color: #ffcc00; text-decoration: none; font-weight: bold;"></a>
            <span th:if="${r.user.usernameField == null || r.user.usernameField.isEmpty()}" 
                  th:text="${r.user.login}" 
                  style="color: #aaa;">(sem username)</span>
        </div>
        <p class="review-comment" th:text="${r.comment}"></p>
        
        <!-- Edit Form (hidden by default) -->
        <div class="review-edit-form" th:id="'edit-form-' + ${r.id}" style="display: none;">
            <form th:action="@{/reviews/update/{id}(id=${r.id})}" method="post">
                <input type="hidden" name="movieId" th:value="${filme.id}">
                <label>Nova avalia√ß√£o (estrelas):</label>
                <div class="star-rating-edit" th:id="'star-rating-edit-' + ${r.id}">
                    <input type="hidden" name="rating" th:id="'rating-edit-' + ${r.id}">
                    <span class="star-clickable empty" data-value="1">‚òÖ</span>
                    <span class="star-clickable empty" data-value="2">‚òÖ</span>
                    <span class="star-clickable empty" data-value="3">‚òÖ</span>
                    <span class="star-clickable empty" data-value="4">‚òÖ</span>
                    <span class="star-clickable empty" data-value="5">‚òÖ</span>
                </div>
                <label>Novo coment√°rio:</label>
                <textarea name="comment" required th:id="'comment-edit-' + ${r.id}"></textarea>
                <div style="margin-top: 10px;">
                    <button type="submit" class="save-btn">üíæ Salvar</button>
                    <button type="button" class="cancel-btn" th:onclick="'cancelEdit(' + ${r.id} + ')'">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script th:src="@{/js/detail.js}"></script>

</div>
</body>
</html>

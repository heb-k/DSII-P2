<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${profileUser.usernameField != null && !profileUser.usernameField.isEmpty() ? profileUser.usernameField : profileUser.login}">Perfil</title>
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
<div class="container">
    <a href="/movies" class="back">⬅ Voltar aos Filmes</a>
    <div class="header">
        <div class="avatar" th:if="${profileUser.photoUrl != null}" >
            <img th:src="${profileUser.photoUrl}" alt="Avatar" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" />
        </div>
        <div class="avatar" th:unless="${profileUser.photoUrl != null}" th:text="${profileUser.usernameField != null && !profileUser.usernameField.isEmpty() ? profileUser.usernameField.substring(0,1).toUpperCase() : profileUser.login.substring(0,1).toUpperCase()}"></div>
        <div>
            <h1 th:text="${profileUser.usernameField != null && !profileUser.usernameField.isEmpty() ? profileUser.usernameField : profileUser.login}"></h1>
            <div class="counts">
                <a th:href="@{/users/{username}/connections(username=${profileUser.usernameField}, tab='followers')}" class="count-link">
                    <div>
                        <span th:text="${followers}">0</span>
                        <small>Seguidores</small>
                    </div>
                </a>
                <a th:href="@{/users/{username}/connections(username=${profileUser.usernameField}, tab='following')}" class="count-link">
                    <div>
                        <span th:text="${following}">0</span>
                        <small>Seguindo</small>
                    </div>
                </a>
            </div>
            <div class="follow-actions" th:if="${authenticated}">
                <div th:if="${!isMe}">
                    <form th:if="${!isFollowing}" th:action="@{/users/{username}/follow(username=${profileUser.usernameField})}" method="post">
                        <button class="follow-btn" type="submit">Seguir</button>
                    </form>
                    <form th:if="${isFollowing}" th:action="@{/users/{username}/unfollow(username=${profileUser.usernameField})}" method="post">
                        <button class="unfollow-btn" type="submit">Deixar de Seguir</button>
                    </form>
                </div>
                <div th:if="${isMe}" style="margin-top:10px; color:#888;">Este é você</div>
            </div>
        </div>
    </div>

    <div class="section-title">Reviews</div>
    <div class="review-list" th:if="${#lists.size(reviews) > 0}">
    <div class="review-item" th:each="r : ${reviews}">
        <div class="stars" th:with="rating=${r.rating}, rounded=${T(java.lang.Math).round(rating * 2) / 2.0}">
            <span th:each="i : ${#numbers.sequence(1,5)}"
                  th:text="'★'"
                  th:classappend="${(rounded >= i) ? 'full' : (rounded >= i - 0.5) ? 'half' : 'empty'}"
                  style="font-family:monospace;"></span>
            <span style="margin-left:8px; color:#ccc;" th:text="|(${rounded}/5)|"></span>
        </div>
        <p th:text="${r.comment}" style="margin:10px 0 8px 0;"></p>
        <a th:href="@{/movies/{id}(id=${r.movie.id})}" class="movie-link" th:text="${r.movie.title}"></a>
    </div>
</div>

    <div class="empty-msg" th:if="${#lists.size(reviews) == 0}">Nenhuma review ainda.</div>
</div>
</body>
</html>